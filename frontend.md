## Frontâ€‘End Engineering Specification  
**Stack:**Â NextÂ .jsÂ 13Â (appÂ router) â€¢ ReactÂ 18 â€¢ TypeScriptÂ 5 â€¢ TailwindÂ CSS 3 â€¢ ReduxÂ Toolkit â€¢ SWR â€¢ yâ€‘js â€¢ serviceâ€‘worker (nextâ€‘pwa)  
**Goals:**Â agentâ€‘centric UX, realâ€‘time collaboration, offlineâ€‘ready PWA, seamless JWT auth, plugâ€‘andâ€‘play with the FastAPI backend described earlier.

---

### 0Â . Repository Layout

```
frontend/
â”œâ”€ .storybook/           # Storybook config
â”œâ”€ app/                  # Next.js appâ€‘router
â”‚  â”œâ”€ layout.tsx
â”‚  â”œâ”€ globals.css
â”‚  â”œâ”€ login/             # /login
â”‚  â”œâ”€ dashboard/         # /dashboard
â”‚  â””â”€ grant/
â”‚     â””â”€ [id]/
â”‚        â”œâ”€ page.tsx     # workspace shell
â”‚        â”œâ”€ editor.tsx   # server component wrapper
â”‚        â””â”€ stream.ts    # Next proxy (Edge runtime) for SSE
â”œâ”€ components/
â”‚  â”œâ”€ ui/                # reusable atoms
â”‚  â”œâ”€ grid/
â”‚  â”‚  â””â”€ Section.tsx
â”‚  â”œâ”€ editor/
â”‚  â”œâ”€ assistant/
â”‚  â”œâ”€ crm/
â”‚  â”œâ”€ compliance/
â”‚  â””â”€ audit/
â”œâ”€ hooks/
â”‚  â”œâ”€ useAuth.ts
â”‚  â”œâ”€ useEventSource.ts
â”‚  â”œâ”€ usePresence.ts
â”‚  â””â”€ useOfflineQueue.ts
â”œâ”€ store/
â”‚  â”œâ”€ index.ts           # configureStore
â”‚  â”œâ”€ slices/
â”‚  â”‚  â”œâ”€ authSlice.ts
â”‚  â”‚  â”œâ”€ docSlice.ts
â”‚  â”‚  â”œâ”€ aiSlice.ts
â”‚  â”‚  â””â”€ crmSlice.ts
â”œâ”€ lib/
â”‚  â”œâ”€ api.ts             # typed fetch wrappers (SWR)
â”‚  â”œâ”€ jwt.ts             # decode/refresh helpers
â”‚  â””â”€ constants.ts
â”œâ”€ public/
â”‚  â””â”€ sw.js              # generated by nextâ€‘pwa
â”œâ”€ tests/                # jest + reactâ€‘testingâ€‘library
â”œâ”€ playwright.config.ts
â””â”€ tailwind.config.js
```

---

### 1Â . Global Tooling & Conventions

| Area | Decision |
|------|----------|
| **Styling** | TailwindÂ CSS; shadcn/ui for primitives (Button, Dialog, Drawer). |
| **Icons** | Lucideâ€‘react. |
| **Charts** | VictoryÂ |Â D3 (custom gauge). |
| **State** | ReduxÂ Toolkit + RTKÂ Query for mutating endpoints; SWR for streaming GET. |
| **Forms** | Reactâ€‘Hookâ€‘Form + Zod validation. |
| **Testing** | Jest (unit), Reactâ€‘Testingâ€‘Library (component), Playwright (e2e). |
| **Linting** | ESLint (airbnbÂ +Â nextÂ +Â tailwindcss plugin) + Prettier. |
| **CI** | GitHub Actions: `pnpm installÂ â†’ typeâ€‘checkÂ â†’ lintÂ â†’ testÂ â†’ build`. |
| **Accessibility** | All interactive components must have keyboard navigation and `aria-*` labels. |
| **Perf Budgets** | LCPÂ <Â 2.5Â s (desktop), JS bundle â‰¤Â 250Â kB gzipped per route. |

---

### 2Â . Auth & Routing

| Taskâ€‘ID | Implementation Steps |
|---------|----------------------|
| **FEâ€‘AUTHâ€‘01** | **JWT Login Form** (`/login/page.tsx`) â€“ email + password â†’ POST `/auth/login`. On success: set HttpOnly `access`, store `refresh` in encrypted `indexedDB` (Dexie table `tokens`). |
| **FEâ€‘AUTHâ€‘02** | **AuthProvider** (client component) â€“ checks cookie via `/auth/me`; if 401, calls `/auth/refresh` with stored token. Provides `user` object via ReactÂ Context. |
| **FEâ€‘AUTHâ€‘03** | **Route Guard HOC** â€“ wraps server components; redirects to `/login` if unauth. |
| **FEâ€‘AUTHâ€‘04** | **Role Check** â€“ `withRole('editor')` to hide/disable UI for viewers. |

---

### 3Â . Grant Workspace ( `/grant/[id]` )

| Zone | Component | Details |
|------|-----------|---------|
| **Grid Canvas** | `EditorCanvas.tsx` | Uses **`reactâ€‘gridâ€‘layout`**. Each cell renders `Section.tsx`, which contains a Draft.js editor instance. Persist layout in Redux `docSlice.layout`. |
| **Sidebar Navigator** | `SectionNav.tsx` | Displays outline; click scrolls into view (reactâ€‘scrollâ€‘intoâ€‘view). |
| **Presence & Cursors** | `usePresence()` hook + `yâ€‘js` awareness; colored avatars follow cursor positions. |
| **Conflict Banner** | If `yDoc.clock > remoteClock + threshold` show MUI Alert â€œUnsynced editsâ€. |
| **Diff Switch** | Toggle to compare *Current* vs *AI Suggestion* using `DiffView.tsx`. |
| **Toolbar** | Bold/italic, heading, upload; plus â€œâš¡Â Generateâ€ button to call AI. |

---

### 4Â . AI Assistant (GrantBot Drawer)

| Step | Implementation |
|------|----------------|
| 1 | **FAB** bottomâ€‘right `<Button className="rounded-full shadow-lg">` opens Drawer. |
| 2 | Drawer contains chat list; message bubble types: `user`, `assistant`, `system` (tool call). |
| 3 | `useEventSource('/agent/run')` hook streams tokens. Parse Serverâ€‘Sent Events: `data: {"role":"assistant","content":"..."}` OR `data: {"tool_call": {...}}`. |
| 4 | On tool call message, display emoji badge:<br>ğŸ” vector_searchÂ â€¦<br>ğŸ“Š crm_fetchÂ â€¦<br>ğŸ›¡ï¸ compliance_checkÂ â€¦ |
| 5 | Provide quickâ€‘reply buttons (â€œRegenerate paragraphâ€, â€œExplain scoreâ€). |
| 6 | When generation completes, insert suggestion into current editor block via OT transaction. |

---

### 5Â . Widgets

| Widget | Technology | Data Flow |
|--------|------------|-----------|
| **Alignment Gauge** | D3 Arc â†’ styled component `<AlignmentGauge score={0.82} />` | Fetch `/align?org&funder`; SWR revalidate on section edit debounceÂ 500Â ms. |
| **Compliance Underlines** | Draft.js decorator; each range with compliance error gets style `text-red-600 dotted underline`. | Fetch `/compliance/check` on autosave; store in Redux `docSlice.complianceMarks`. |
| **Toast Alerts** | Reactâ€‘Toastify; on guardrail violation (`severity > threshold`) show blocking toast w/ â€œOverrideâ€ & â€œReviseâ€ buttons. |
| **CRM Charts** | VictoryBar (donations) & VictoryLine (program outcomes). Data: `/crm/org/{id}/context`. Memoized via SWR. |
| **Deadline Timeline** | `react-vertical-timeline-component`; each milestone computed from `docSlice.deadlines`. |

---

### 6Â . Realâ€‘Time Collaboration

| Task | Details |
|------|---------|
| FEâ€‘RTâ€‘01 | Add `y-websocket` provider pointing to `wss://api/ws/{doc_id}` (backend Bâ€‘10). |
| FEâ€‘RTâ€‘02 | Integrate Draft.js with `yjs-draft` binding. |
| FEâ€‘RTâ€‘03 | Persist snapshots to IndexedDB every 30s (`y-indexeddb` plugin) for offline. |
| FEâ€‘RTâ€‘04 | On reconnect, backend OT merges; show merge dialog if conflicts. |

---

### 7Â . State & Persistence

| Slice | State Shape |
|-------|-------------|
| `auth` | `{ user: User|null, accessExp: number }` |
| `workspace` | `{ docId, layout, activeSectionId }` |
| `aiDrafts` | `{ [sectionId]: {content, status:'idle'|'streaming'|'done'} }` |
| `crm` | `{ orgContext, lastSync }` |

- **Dexie DB** tables: `offlineEdits`, `tokens`, `docCache`.  
- `useOfflineQueue` hook pushes POST/PUT calls into `offlineEdits` when `navigator.onLine===false`; flushes FIFO on reconnect.

---

### 8Â . Export & Submission

| Flow | Implementation |
|------|----------------|
| **Export** | Button triggers `/assemble` â†’ `blob`. Use `file-saver` to download. Provide â€œMarkdownâ€ or â€œPDFâ€ options. |
| **Submit** | Modal collects funder API creds; POST `/submission`. On success show blockchain tx hash & copyâ€‘clipboard. |

---

### 9Â . Audit Viewer ( `/grant/[id]/audit` )

| Feature | Details |
|---------|---------|
| Version Slider | MUI Slider range 1..N; updates query to `/audit/{docId}/diff?v1=&v2=`. |
| Diff Display | `react-diff-viewer` split mode, color coding (green add, red del). |
| Filters | `Chip` group â€œAI / User / Allâ€, date picker. |

---

### 10Â . PWA & Offline

| Step | Library / Config |
|------|------------------|
| nextâ€‘pwa | `next.config.js` with runtimeCaching for: `/_next/static/**`, `/api/**`, `/grant/**` HTML. |
| Service Worker | Listen to `message: 'SYNC_QUEUE'` to flush Dexie offline actions. |
| Banner | `useOnlineStatus` hook; show `Snackbar` â€œYouâ€™re offline â€“ edits will sync automatically.â€ |

---


---

### 12Â . Testing Matrix

| Layer | Tool | Coverage Goal |
|-------|------|---------------|
| Unit | JestÂ +Â RTL | 80Â % lines for utils (hooks, reducers). |
| Component | Storybook interaction tests | All critical UI states. |
| Integration | Playwright | Login flow, AI generation, offline edit, diff viewer. |

---

### 13Â . Build & Deployment

1. **`pnpm build`** (Next) â†’ `.next` output.  
2. **Dockerfile** (multiâ€‘stage):  
   ```Dockerfile
   FROM node:20-alpine as build
   WORKDIR /app
   COPY . .
   RUN pnpm install --frozen-lockfile && pnpm build

   FROM nginx:1.25-alpine
   COPY --from=build /app/out /usr/share/nginx/html
   COPY nginx.conf /etc/nginx/conf.d/default.conf
   ```
3. Helm `frontend` chart with `ingress`, `env NEXT_PUBLIC_API_URL`, HPA.

---

### 14Â . Performance & Accessibility Gates (CI)

| Check | Threshold |
|-------|-----------|
| Lighthouse LCP | â‰¤Â 2.5Â s desktop |
| Total JS | â‰¤Â 250Â kB gzipped route |
| aXe violations | 0 critical, 0 serious |

CI fails if budgets exceeded (use `lhci` & `axe-playwright`).

---

### 15Â . Live Demo Script

1. **Login** (credentials seeded).  
2. Open existing grant âœ alignment gauge displays 82Â %.  
3. Click a paragraph âœ press **Generate** âœ GrantBot streams new content.  
4. Guardrail toast pops (mission drift) âœ choose â€œReviseâ€.  
5. Teammate joins âœ colored cursor visible; simultaneous edit.  
6. Disconnect Wiâ€‘Fi âœ offline banner; make edits; reconnect âœ auto sync.  
7. Export PDF âœ download; Submit âœ tx hash toast.  
8. View Audit diff v3 vs v5.

---

## Summary Checklist for Developers

- [ ] Set up **NextÂ 13** project with Tailwind, TypeScript, ESLint, Prettier.  
- [ ] Implement **AuthProvider** & route guards.  
- [ ] Build **EditorCanvas** with `react-grid-layout` and Draft.js.  
- [ ] Integrate **GrantBot** SSE chat with agent endpoint.  
- [ ] Implement **Alignment gauge** & **Compliance marks** via backend APIs.  
- [ ] Add **CRM charts**, **timeline**, **export**, **submission** flows.  
- [ ] Enable **yâ€‘js** realâ€‘time editing & IndexedDB offline cache.  
- [ ] Configure **nextâ€‘pwa** service worker; Dexie offline queue.  
- [ ] Ship Storybook stories & unit tests.  
- [ ] Pass Lighthouse & aXe budgets.  
