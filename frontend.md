## Front‑End Engineering Specification  
**Stack:** Next .js 13 (app router) • React 18 • TypeScript 5 • Tailwind CSS 3 • Redux Toolkit • SWR • y‑js • service‑worker (next‑pwa)  
**Goals:** agent‑centric UX, real‑time collaboration, offline‑ready PWA, seamless JWT auth, plug‑and‑play with the FastAPI backend described earlier.

---

### 0 . Repository Layout

```
frontend/
├─ .storybook/           # Storybook config
├─ app/                  # Next.js app‑router
│  ├─ layout.tsx
│  ├─ globals.css
│  ├─ login/             # /login
│  ├─ dashboard/         # /dashboard
│  └─ grant/
│     └─ [id]/
│        ├─ page.tsx     # workspace shell
│        ├─ editor.tsx   # server component wrapper
│        └─ stream.ts    # Next proxy (Edge runtime) for SSE
├─ components/
│  ├─ ui/                # reusable atoms
│  ├─ grid/
│  │  └─ Section.tsx
│  ├─ editor/
│  ├─ assistant/
│  ├─ crm/
│  ├─ compliance/
│  └─ audit/
├─ hooks/
│  ├─ useAuth.ts
│  ├─ useEventSource.ts
│  ├─ usePresence.ts
│  └─ useOfflineQueue.ts
├─ store/
│  ├─ index.ts           # configureStore
│  ├─ slices/
│  │  ├─ authSlice.ts
│  │  ├─ docSlice.ts
│  │  ├─ aiSlice.ts
│  │  └─ crmSlice.ts
├─ lib/
│  ├─ api.ts             # typed fetch wrappers (SWR)
│  ├─ jwt.ts             # decode/refresh helpers
│  └─ constants.ts
├─ public/
│  └─ sw.js              # generated by next‑pwa
├─ tests/                # jest + react‑testing‑library
├─ playwright.config.ts
└─ tailwind.config.js
```

---

### 1 . Global Tooling & Conventions

| Area | Decision |
|------|----------|
| **Styling** | Tailwind CSS; shadcn/ui for primitives (Button, Dialog, Drawer). |
| **Icons** | Lucide‑react. |
| **Charts** | Victory | D3 (custom gauge). |
| **State** | Redux Toolkit + RTK Query for mutating endpoints; SWR for streaming GET. |
| **Forms** | React‑Hook‑Form + Zod validation. |
| **Testing** | Jest (unit), React‑Testing‑Library (component), Playwright (e2e). |
| **Linting** | ESLint (airbnb + next + tailwindcss plugin) + Prettier. |
| **CI** | GitHub Actions: `pnpm install → type‑check → lint → test → build`. |
| **Accessibility** | All interactive components must have keyboard navigation and `aria-*` labels. |
| **Perf Budgets** | LCP < 2.5 s (desktop), JS bundle ≤ 250 kB gzipped per route. |

---

### 2 . Auth & Routing

| Task‑ID | Implementation Steps |
|---------|----------------------|
| **FE‑AUTH‑01** | **JWT Login Form** (`/login/page.tsx`) – email + password → POST `/auth/login`. On success: set HttpOnly `access`, store `refresh` in encrypted `indexedDB` (Dexie table `tokens`). |
| **FE‑AUTH‑02** | **AuthProvider** (client component) – checks cookie via `/auth/me`; if 401, calls `/auth/refresh` with stored token. Provides `user` object via React Context. |
| **FE‑AUTH‑03** | **Route Guard HOC** – wraps server components; redirects to `/login` if unauth. |
| **FE‑AUTH‑04** | **Role Check** – `withRole('editor')` to hide/disable UI for viewers. |

---

### 3 . Grant Workspace ( `/grant/[id]` )

| Zone | Component | Details |
|------|-----------|---------|
| **Grid Canvas** | `EditorCanvas.tsx` | Uses **`react‑grid‑layout`**. Each cell renders `Section.tsx`, which contains a Draft.js editor instance. Persist layout in Redux `docSlice.layout`. |
| **Sidebar Navigator** | `SectionNav.tsx` | Displays outline; click scrolls into view (react‑scroll‑into‑view). |
| **Presence & Cursors** | `usePresence()` hook + `y‑js` awareness; colored avatars follow cursor positions. |
| **Conflict Banner** | If `yDoc.clock > remoteClock + threshold` show MUI Alert “Unsynced edits”. |
| **Diff Switch** | Toggle to compare *Current* vs *AI Suggestion* using `DiffView.tsx`. |
| **Toolbar** | Bold/italic, heading, upload; plus “⚡ Generate” button to call AI. |

---

### 4 . AI Assistant (GrantBot Drawer)

| Step | Implementation |
|------|----------------|
| 1 | **FAB** bottom‑right `<Button className="rounded-full shadow-lg">` opens Drawer. |
| 2 | Drawer contains chat list; message bubble types: `user`, `assistant`, `system` (tool call). |
| 3 | `useEventSource('/agent/run')` hook streams tokens. Parse Server‑Sent Events: `data: {"role":"assistant","content":"..."}` OR `data: {"tool_call": {...}}`. |
| 4 | On tool call message, display emoji badge:<br>🔍 vector_search …<br>📊 crm_fetch …<br>🛡️ compliance_check … |
| 5 | Provide quick‑reply buttons (“Regenerate paragraph”, “Explain score”). |
| 6 | When generation completes, insert suggestion into current editor block via OT transaction. |

---

### 5 . Widgets

| Widget | Technology | Data Flow |
|--------|------------|-----------|
| **Alignment Gauge** | D3 Arc → styled component `<AlignmentGauge score={0.82} />` | Fetch `/align?org&funder`; SWR revalidate on section edit debounce 500 ms. |
| **Compliance Underlines** | Draft.js decorator; each range with compliance error gets style `text-red-600 dotted underline`. | Fetch `/compliance/check` on autosave; store in Redux `docSlice.complianceMarks`. |
| **Toast Alerts** | React‑Toastify; on guardrail violation (`severity > threshold`) show blocking toast w/ “Override” & “Revise” buttons. |
| **CRM Charts** | VictoryBar (donations) & VictoryLine (program outcomes). Data: `/crm/org/{id}/context`. Memoized via SWR. |
| **Deadline Timeline** | `react-vertical-timeline-component`; each milestone computed from `docSlice.deadlines`. |

---

### 6 . Real‑Time Collaboration

| Task | Details |
|------|---------|
| FE‑RT‑01 | Add `y-websocket` provider pointing to `wss://api/ws/{doc_id}` (backend B‑10). |
| FE‑RT‑02 | Integrate Draft.js with `yjs-draft` binding. |
| FE‑RT‑03 | Persist snapshots to IndexedDB every 30s (`y-indexeddb` plugin) for offline. |
| FE‑RT‑04 | On reconnect, backend OT merges; show merge dialog if conflicts. |

---

### 7 . State & Persistence

| Slice | State Shape |
|-------|-------------|
| `auth` | `{ user: User|null, accessExp: number }` |
| `workspace` | `{ docId, layout, activeSectionId }` |
| `aiDrafts` | `{ [sectionId]: {content, status:'idle'|'streaming'|'done'} }` |
| `crm` | `{ orgContext, lastSync }` |

- **Dexie DB** tables: `offlineEdits`, `tokens`, `docCache`.  
- `useOfflineQueue` hook pushes POST/PUT calls into `offlineEdits` when `navigator.onLine===false`; flushes FIFO on reconnect.

---

### 8 . Export & Submission

| Flow | Implementation |
|------|----------------|
| **Export** | Button triggers `/assemble` → `blob`. Use `file-saver` to download. Provide “Markdown” or “PDF” options. |
| **Submit** | Modal collects funder API creds; POST `/submission`. On success show blockchain tx hash & copy‑clipboard. |

---

### 9 . Audit Viewer ( `/grant/[id]/audit` )

| Feature | Details |
|---------|---------|
| Version Slider | MUI Slider range 1..N; updates query to `/audit/{docId}/diff?v1=&v2=`. |
| Diff Display | `react-diff-viewer` split mode, color coding (green add, red del). |
| Filters | `Chip` group “AI / User / All”, date picker. |

---

### 10 . PWA & Offline

| Step | Library / Config |
|------|------------------|
| next‑pwa | `next.config.js` with runtimeCaching for: `/_next/static/**`, `/api/**`, `/grant/**` HTML. |
| Service Worker | Listen to `message: 'SYNC_QUEUE'` to flush Dexie offline actions. |
| Banner | `useOnlineStatus` hook; show `Snackbar` “You’re offline – edits will sync automatically.” |

---


---

### 12 . Testing Matrix

| Layer | Tool | Coverage Goal |
|-------|------|---------------|
| Unit | Jest + RTL | 80 % lines for utils (hooks, reducers). |
| Component | Storybook interaction tests | All critical UI states. |
| Integration | Playwright | Login flow, AI generation, offline edit, diff viewer. |

---

### 13 . Build & Deployment

1. **`pnpm build`** (Next) → `.next` output.  
2. **Dockerfile** (multi‑stage):  
   ```Dockerfile
   FROM node:20-alpine as build
   WORKDIR /app
   COPY . .
   RUN pnpm install --frozen-lockfile && pnpm build

   FROM nginx:1.25-alpine
   COPY --from=build /app/out /usr/share/nginx/html
   COPY nginx.conf /etc/nginx/conf.d/default.conf
   ```
3. Helm `frontend` chart with `ingress`, `env NEXT_PUBLIC_API_URL`, HPA.

---

### 14 . Performance & Accessibility Gates (CI)

| Check | Threshold |
|-------|-----------|
| Lighthouse LCP | ≤ 2.5 s desktop |
| Total JS | ≤ 250 kB gzipped route |
| aXe violations | 0 critical, 0 serious |

CI fails if budgets exceeded (use `lhci` & `axe-playwright`).

---

### 15 . Live Demo Script

1. **Login** (credentials seeded).  
2. Open existing grant ➜ alignment gauge displays 82 %.  
3. Click a paragraph ➜ press **Generate** ➜ GrantBot streams new content.  
4. Guardrail toast pops (mission drift) ➜ choose “Revise”.  
5. Teammate joins ➜ colored cursor visible; simultaneous edit.  
6. Disconnect Wi‑Fi ➜ offline banner; make edits; reconnect ➜ auto sync.  
7. Export PDF ➜ download; Submit ➜ tx hash toast.  
8. View Audit diff v3 vs v5.

---

## Summary Checklist for Developers

- [ ] Set up **Next 13** project with Tailwind, TypeScript, ESLint, Prettier.  
- [ ] Implement **AuthProvider** & route guards.  
- [ ] Build **EditorCanvas** with `react-grid-layout` and Draft.js.  
- [ ] Integrate **GrantBot** SSE chat with agent endpoint.  
- [ ] Implement **Alignment gauge** & **Compliance marks** via backend APIs.  
- [ ] Add **CRM charts**, **timeline**, **export**, **submission** flows.  
- [ ] Enable **y‑js** real‑time editing & IndexedDB offline cache.  
- [ ] Configure **next‑pwa** service worker; Dexie offline queue.  
- [ ] Ship Storybook stories & unit tests.  
- [ ] Pass Lighthouse & aXe budgets.  
